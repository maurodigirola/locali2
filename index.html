<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Locali Firenze 2.0</title>
  <link rel="manifest" href="manifest.json?v=3">
  <meta name="theme-color" content="#ff7e5f">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
    h1 { text-align: center; margin-bottom: 20px; }
    .filters, #filtri { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 15px; }
    input, button, select, textarea { padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 1em; }
    button { background: #ff7e5f; color: white; cursor: pointer; border: none; transition: 0.3s; }
    button:hover { background: #eb5757; }
    .list { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px; max-height: 70vh; overflow-y: auto; }
    .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    .card div { max-width: 220px; word-wrap: break-word; white-space: normal; }
    .card a { color: #0077cc; text-decoration: none; }
    .actions { display: flex; flex-direction: column; align-items: center; gap: 8px; }
    .remove, .edit { border-radius: 50%; width: 30px; height: 30px; font-weight: bold; color: white; cursor: pointer; }
    .edit { background: #ffa500; }
    .remove { background: #ff4d4d; }
    .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; }
    .popup { background:white; padding:20px; border-radius:10px; max-width:300px; text-align:center; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>

<body>
  <h1>Locali Firenze 2.0</h1>

  <!-- barra filtri -->
  <div id="filtri">
    <button onclick="filtra()">Filtra</button>
    <button onclick="randomLocale()">Casuale ðŸŽ²</button>
    <button onclick="vaiAlModulo()">Aggiungi âž•</button>
    <input id="searchInput" type="text" placeholder="Cerca locale..." style="padding:8px; width:250px;">
  </div>

  <!-- lista risultati -->
  <div class="list" id="lista"></div>

  <!-- form aggiunta -->
  <h2 id="formAggiungi">Aggiungi Locale</h2>
  <div class="filters">
    <input type="text" id="nome" placeholder="Nome locale">
    <input type="text" id="zona" placeholder="Zona (es. Santo Spirito)">
    <select id="tipo">
      <option value="">Tipo</option>
      <option>Pizzeria</option><option>Ristorante</option>
      <option>Aperitivo</option><option>Cocktail bar</option>
      <option>Paninoteca</option>
    </select>
    <input type="text" id="link" placeholder="Link Google">
    <select id="voto"><option value="">Voto</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select>
    <select id="glutenFree"><option value="">Gluten free?</option><option value="si">SÃ¬</option><option value="no">No</option></select>
    <textarea id="commento" placeholder="Commento sul locale" rows="2" style="width:100%;"></textarea>
    <button onclick="aggiungi()">Aggiungi</button>
  </div>

  <!-- popup -->
  <div class="overlay" id="popupGenerico">
    <div class="popup">
      <h3 id="popupTitolo"></h3>
      <p id="popupMessaggio"></p>
      <button onclick="chiudiPopupGenerico()">OK</button>
    </div>
  </div>

  <!-- loader -->
  <div id="loader" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.7); align-items:center; justify-content:center; z-index:9999;">
    <div class="spinner" style="border: 6px solid #f3f3f3; border-top: 6px solid #ff7e5f; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;"></div>
  </div>

  <script>
  const SCRIPT_URL_LOCALI = "https://script.google.com/macros/s/AKfycbwt6REPdUGMk02NE-VBxu8vcauaAngZ8AzexZcq1XQFmeBKaroRxOM57jKK-Of-_lcC/exec";
  let myName = localStorage.getItem("myName") || prompt("Inserisci nome e cognome:") || "Anonimo";
  localStorage.setItem("myName", myName.trim());

  let locali = [];
  let zone = [];
  let userPosition = null;

  function mostraPopup(t, m) {
    document.getElementById("popupTitolo").textContent = t;
    document.getElementById("popupMessaggio").textContent = m;
    document.getElementById("popupGenerico").style.display = "flex";
  }
  function chiudiPopupGenerico() { document.getElementById("popupGenerico").style.display = "none"; }
  function mostraLoader() { document.getElementById("loader").style.display = "flex"; }
  function nascondiLoader() { document.getElementById("loader").style.display = "none"; }

  async function carica() {
    try {
      mostraLoader();
      const res = await fetch(SCRIPT_URL_LOCALI);
      const data = await res.json();
      locali = Array.isArray(data) ? data : (data.locali || []);
      const mapZone = {};
      locali.forEach(l => { if (l.zona && l.lat && l.lon) mapZone[l.zona] = { lat:+l.lat, lon:+l.lon }; });
      zone = Object.entries(mapZone).map(([zona, coords]) => ({ zona, lat:coords.lat, lon:coords.lon }));
      mostra();
      aggiornaFiltri();
    } catch (err) {
      console.error("Errore caricamento dati:", err);
    } finally {
      nascondiLoader();
    }
  }

  function creaDropdown(id, placeholder, options) {
    const container = document.getElementById("filtri");
    let select = document.getElementById(id);
    if (select) select.remove();
    select = document.createElement("select");
    select.id = id;
    select.innerHTML = `<option value="">${placeholder}</option>` +
      options.map(o => `<option value="${o}">${o}</option>`).join("");
    select.style.margin = "5px";
    container.appendChild(select);
  }

  function aggiornaFiltri() {
    const zoneUnique = [...new Set(locali.map(l => l.zona).filter(Boolean))];
    creaDropdown("zonaFilter", "Zona", ["PiÃ¹ vicino a me", ...zoneUnique]);
    const tipiUnique = [...new Set(locali.flatMap(l => l.tipo ? l.tipo.split("+") : []))];
    creaDropdown("tipoFilter", "Tipo", tipiUnique);
    const consUnique = [...new Set(locali.map(l => l.consigliatoDa || "â€”"))];
    creaDropdown("consigliatoFilter", "Consigliato da", consUnique);
    const gfUnique = [...new Set(locali.map(l => l.glutenFree || "â€”"))];
    creaDropdown("glutenFilter", "Gluten free", gfUnique);
  }

  async function filtra() {
    let zonaSel = document.getElementById("zonaFilter")?.value || "";
    const tipoSel = document.getElementById("tipoFilter")?.value || "";
    const consSel = document.getElementById("consigliatoFilter")?.value || "";
    const gfSel = document.getElementById("glutenFilter")?.value || "";
    const query = document.getElementById("searchInput").value.toLowerCase();

    if (zonaSel === "PiÃ¹ vicino a me") {
      try {
        zonaSel = await trovaZonaPiuVicino();
        if (zonaSel) mostraPopup("Zona piÃ¹ vicina", `Ti trovi vicino a: ${zonaSel}`);
      } catch { zonaSel = ""; }
    }

    const f = locali.filter(l => {
      const matchZona = !zonaSel || l.zona === zonaSel;
      const matchTipo = !tipoSel || (l.tipo && l.tipo.includes(tipoSel));
      const matchCons = !consSel || l.consigliatoDa === consSel;
      const matchGF = !gfSel || l.glutenFree === gfSel;
      const matchQuery = !query || l.nome.toLowerCase().includes(query);
      return matchZona && matchTipo && matchCons && matchGF && matchQuery;
    });
    mostra(f);
  }

  function mostra(lista = locali) {
    const c = document.getElementById("lista");
    c.innerHTML = "";
    lista.forEach((l, i) => {
      const isOwner = l.consigliatoDa && l.consigliatoDa.trim().toLowerCase() === myName.trim().toLowerCase();
      const isAdmin = myName.trim().toLowerCase() === "mauro di girolamo";
      c.innerHTML += `
        <div class="card" data-idx="${i}">
          <div>
            <strong>${l.nome}</strong> ${l.glutenFree==="si" ? "ðŸŒ¾ðŸš«" : ""}<br>
            Zona: ${l.zona}<br>
            Tipo: ${l.tipo}<br>
            Voto: ${l.voto || "â€”"}<br>
            Consigliato da: ${l.consigliatoDa || "â€”"}<br>
            <a href="${l.link}" target="_blank">Link</a>
          </div>
          <div class="actions">
            ${(isOwner || isAdmin) ? `<button class="edit" onclick="modifica(${i})">âœŽ</button><button class="remove" onclick="rimuovi(${i})">Ã—</button>` : ""}
          </div>
        </div>`;
    });
  }

  function vaiAlModulo() { document.getElementById("formAggiungi").scrollIntoView({ behavior:"smooth" }); }

  async function aggiungi() {
    const nome = nome.value.trim(), zona = zona.value.trim(), tipo = tipo.value.trim();
    const link = document.getElementById("link").value.trim();
    const voto = voto.value, glutenFree = glutenFree.value;
    const commento = commento.value.trim();
    if (!nome || !zona || !tipo) return mostraPopup("Attenzione âš ï¸","Inserisci Nome, Zona e Tipo!");
    const nuovo = { action:"add", nome, zona, tipo, link, voto, consigliatoDa:myName, glutenFree, commento };
    try {
      mostraLoader();
      await fetch(SCRIPT_URL_LOCALI,{method:"POST",body:JSON.stringify(nuovo)});
      await carica();
      mostraPopup("Fatto!","Locale aggiunto con successo");
    } catch(e){ console.error(e); } finally { nascondiLoader(); }
  }

  function distanza(lat1, lon1, lat2, lon2) {
    const R=6371,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180;
    const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  }

  async function trovaZonaPiuVicino() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) return reject();
      navigator.geolocation.getCurrentPosition(pos=>{
        userPosition={lat:pos.coords.latitude,lon:pos.coords.longitude};
        if(zone.length===0) return reject();
        let best=null,min=Infinity;
        zone.forEach(z=>{
          const d=distanza(userPosition.lat,userPosition.lon,z.lat,z.lon);
          if(d<min){min=d;best=z.zona;}
        });
        resolve(best);
      },err=>reject(err));
    });
  }

  function randomLocale() {
    if (!locali.length) return mostraPopup("Vuoto","Nessun locale disponibile");
    const r = locali[Math.floor(Math.random()*locali.length)];
    mostraPopup("Locale casuale ðŸŽ²",`${r.nome} (${r.tipo}, zona ${r.zona})`);
  }

  carica();
  </script>
</body>
</html>
