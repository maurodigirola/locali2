<script>
const SCRIPT_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgxFCJqwSpVglXYgbjsTVtpinBhAU9Ms5HUP3DIvMpKiugB859Z-EmTF1tKdVqPRufCMJOPN-B8pMfm3X8reUTKAIgZQUjZ2FohGSqO3P9j1vTGnZuqmoSd1pFRExSO2PApUFStZo9oH1cVSuOg0B2f9VbJy-0KlKSlEGLsv_ujN4LwJWhQ-nysQXreRb_jjgIonLBGLvjGHpNv94OHPL6aDacmvdw0Ct6UE7k1ZOikk-u_r0JuJmiwkWY0a9u4x8y2y6D4gmuPvqXzz1xYz33DjedjYQ&lib=MyKJ4cH5uv4a9pqFCsv6jtOoUuG5-a_8Z";

let locali = [];
let commenti = [];
let zone = [];

// Carica tutto dal backend
async function caricaDati() {
  try {
    const res = await fetch(SCRIPT_URL, { cache: "no-store" });
    const data = await res.json();
    if (!data.locali || !Array.isArray(data.locali)) throw new Error("Errore nel formato dati");
    locali = data.locali;
    commenti = data.commenti || [];
    zone = data.zone || [];
    mostra(locali);
  } catch (err) {
    console.error("Errore nel caricamento:", err);
    alert("Errore nel caricamento dei dati. Riprova più tardi.");
  }
}

function mostra(lista = locali) {
  const container = document.getElementById("lista");
  container.innerHTML = "";
  lista.forEach((loc, index) => {
    container.innerHTML += `
      <div class="card" id="card-${index}">
        <div>
          <strong>${loc.nome}</strong><br>
          Zona: ${loc.zona} | Tipo: ${loc.tipo} | Voto: ${loc.voto || "—"} <br>
          ${loc.link ? `<a href="${loc.link}" target="_blank">Mappa</a>` : ""}
        </div>
        <div class="actions">
          <button class="edit" onclick="modifica(${index})">✎</button>
          <button class="remove" onclick="rimuovi(${index})">×</button>
        </div>
      </div>
    `;
  });
}

function filtra() {
  const zona = document.getElementById("zonaFilter").value;
  const tipo = document.getElementById("tipoFilter").value;
  let filtrati = locali.filter(l =>
    (zona === "" || l.zona === zona) &&
    (tipo === "" || l.tipo === tipo)
  );
  mostra(filtrati);
}

function randomLocale() {
  if (locali.length === 0) { alert("Nessun locale disponibile"); return; }
  const r = locali[Math.floor(Math.random() * locali.length)];
  alert(`Prova: ${r.nome} (${r.tipo} in zona ${r.zona})`);
}

// funzioni segnaposto (da completare in step successivi)
function aggiungi() { alert("Funzione Aggiungi in aggiornamento..."); }
function rimuovi() { alert("Funzione Rimuovi in aggiornamento..."); }
function modifica() { alert("Funzione Modifica in aggiornamento..."); }

// Avvio iniziale
window.addEventListener("load", caricaDati);
</script>


