<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Locali Firenze 2.0</title>
  <link rel="manifest" href="manifest.json?v=3">
  <meta name="theme-color" content="#ff7e5f">

  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
    h1 { text-align: center; margin-bottom: 20px; }
    .filters { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; justify-content: center; }
    .filter-buttons { text-align: center; margin: 10px 0; }
    input, button, select, textarea { padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 1em; }
    button { background: #ff7e5f; color: white; cursor: pointer; border: none; transition: 0.3s; }
    button:hover { background: #eb5757; }
    .list { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px; max-height: 70vh; overflow-y: auto; }
    .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: flex-start; flex-direction: row; }
    .card div { max-width: 240px; word-wrap: break-word; white-space: normal; }
    .card a { color: #0077cc; text-decoration: none; }
    .actions { display: flex; flex-direction: column; align-items: center; gap: 8px; }
    .remove, .edit { border-radius: 50%; width: 30px; height: 30px; font-weight: bold; color: white; cursor: pointer; }
    .edit { background: #ffa500; }
    .remove { background: #ff4d4d; }
    .comment { background: #ff9966; border: none; border-radius: 50%; color: white; font-weight: bold; width: 30px; height: 30px; cursor: pointer; }
    .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; }
    .popup { background:white; padding:20px; border-radius:10px; max-width:300px; text-align:center; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>

<body>
  <h1>Locali Firenze 2.0</h1>

  <div id="filtri" style="margin-top:20px; text-align:center;">
    <button onclick="filtra()">Filtra</button>
    <button onclick="randomLocale()">Casuale üé≤</button>
    <button onclick="vaiAlModulo()">Aggiungi ‚ûï</button><br><br>
    <input id="searchInput" type="text" placeholder="Cerca locale..." style="padding:8px; width:250px;">
  </div>

  <div class="filters">
    <div id="zonaFilter"></div>
    <div id="tipoFilter"></div>
    <div id="consigliatoFilter"></div>
    <div id="glutenFilter"></div>
  </div>

  <div id="loader" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.7); align-items:center; justify-content:center; z-index:9999;">
    <div class="spinner" style="border: 6px solid #f3f3f3; border-top: 6px solid #ff7e5f; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;"></div>
  </div>

  <div class="list" id="lista"></div>

  <h2 id="formAggiungi">Aggiungi Locale</h2>
  <div class="filters">
    <input type="text" id="nome" placeholder="Nome locale">
    <input type="text" id="zona" placeholder="Zona (es. Santo Spirito)">
    <select id="tipo">
      <option value="">Tipo</option>
      <option>Pizzeria</option><option>Ristorante</option><option>Aperitivo</option><option>Cocktail bar</option><option>Paninoteca</option>
    </select>
    <input type="text" id="link" placeholder="Link Google">
    <select id="voto"><option value="">Voto</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select>
    <select id="glutenFree"><option value="">Gluten free?</option><option value="si">S√¨</option><option value="no">No</option></select>
    <textarea id="commento" placeholder="Commento sul locale" rows="2" style="width:100%;"></textarea>
    <button onclick="aggiungi()">Aggiungi</button>
  </div>

  <div class="overlay" id="popupGenerico">
    <div class="popup">
      <h3 id="popupTitolo"></h3>
      <p id="popupMessaggio"></p>
      <button onclick="chiudiPopupGenerico()">OK</button>
    </div>
  </div>

  <script>
  const SCRIPT_URL_LOCALI = "https://script.google.com/macros/s/AKfycbwt6REPdUGMk02NE-VBxu8vcauaAngZ8AzexZcq1XQFmeBKaroRxOM57jKK-Of-_lcC/exec";

  let myName = localStorage.getItem("myName") || prompt("Inserisci nome e cognome:") || "Anonimo";
  localStorage.setItem("myName", myName.trim());

  let locali = [];
  let commenti = [];
  let zone = [];
  let userPosition = null;

  function mostraPopup(t, m) {
    document.getElementById("popupTitolo").textContent = t;
    document.getElementById("popupMessaggio").textContent = m;
    document.getElementById("popupGenerico").style.display = "flex";
  }
  function chiudiPopupGenerico() { document.getElementById("popupGenerico").style.display = "none"; }
  function mostraLoader() { document.getElementById("loader").style.display = "flex"; }
  function nascondiLoader() { document.getElementById("loader").style.display = "none"; }

  async function carica() {
    try {
      mostraLoader();
      const res = await fetch(SCRIPT_URL_LOCALI);
      const data = await res.json();
      locali = data.locali || [];
      commenti = data.commenti || [];
      zone = data.zone || [];
      mostra();
      aggiornaFiltri();
    } catch (err) {
      console.error("Errore caricamento dati:", err);
    } finally {
      nascondiLoader();
    }
  }

  function creaDropdown(id, placeholder, options) {
    const container = document.getElementById("filtri");
    let select = document.getElementById(id);
    if (select) select.remove();

    select = document.createElement("select");
    select.id = id;
    select.innerHTML = `<option value="">${placeholder}</option><option value="Tutti">Tutti</option>` +
      options.map(o => `<option value="${o}">${o}</option>`).join("");
    select.style.margin = "5px";
    container.appendChild(select);
  }

  function getSelezionato(id) {
    const el = document.getElementById(id);
    return el ? el.value : "";
  }

  function aggiornaFiltri() {
    const zoneUnique = [...new Set(locali.map(l => l.zona).filter(Boolean))];
    creaDropdown("zonaFilter", "Zona", ["Pi√π vicino a me", ...zoneUnique]);

    const tipiUnique = [...new Set(locali.flatMap(l => l.tipo ? l.tipo.split("+") : []))];
    creaDropdown("tipoFilter", "Tipo", tipiUnique);

    const consUnique = [...new Set(locali.map(l => l.consigliatoDa || "‚Äî"))];
    creaDropdown("consigliatoFilter", "Consigliato da", consUnique);

    const gfUnique = [...new Set(locali.map(l => l.glutenFree || "‚Äî"))];
    creaDropdown("glutenFilter", "Gluten free", gfUnique);
  }

  async function filtra() {
    let zonaSel = getSelezionato("zonaFilter");
    const tipoSel = getSelezionato("tipoFilter");
    const consSel = getSelezionato("consigliatoFilter");
    const gfSel = getSelezionato("glutenFilter");
    const query = document.getElementById("searchInput").value.toLowerCase();

    if (zonaSel === "Pi√π vicino a me") {
      try {
        zonaSel = await trovaZonaPiuVicino();
        if (zonaSel) mostraPopup("Zona pi√π vicina", `Ti trovi vicino a: ${zonaSel}`);
      } catch {
        zonaSel = "";
      }
    }

    const f = locali.filter(l => {
      const matchZona = !zonaSel || zonaSel === "Tutti" || l.zona === zonaSel;
      const matchTipo = !tipoSel || tipoSel === "Tutti" || (l.tipo && l.tipo.includes(tipoSel));
      const matchCons = !consSel || consSel === "Tutti" || l.consigliatoDa === consSel;
      const matchGF = !gfSel || gfSel === "Tutti" || l.glutenFree === gfSel;
      const matchQuery = !query || l.nome.toLowerCase().includes(query);
      return matchZona && matchTipo && matchCons && matchGF && matchQuery;
    });
    mostra(f);
  }

  function getCommentiPerLocale(id_locale) {
    return commenti.filter(c => c.ID_locale === id_locale);
  }

  async function aggiungiCommento(id_locale) {
    const testo = prompt("Scrivi il tuo commento:");
    if (!testo) return;
    const nuovo = { action: "addComment", id_locale, autore: myName, testo };
    try {
      mostraLoader();
      await fetch(SCRIPT_URL_LOCALI, { method: "POST", body: JSON.stringify(nuovo) });
      await carica();
    } catch (e) { console.error(e); } finally { nascondiLoader(); }
  }

  async function eliminaCommento(id_commento) {
    if (!confirm("Vuoi eliminare questo commento?")) return;
    try {
      mostraLoader();
      await fetch(SCRIPT_URL_LOCALI, { method: "POST", body: JSON.stringify({ action: "deleteComment", id_commento }) });
      await carica();
    } catch (e) { console.error(e); } finally { nascondiLoader(); }
  }

  function mostra(lista = locali) {
    const c = document.getElementById("lista");
    c.innerHTML = "";
    lista.forEach((l, i) => {
      const isOwner = l.consigliatoDa && l.consigliatoDa.trim().toLowerCase() === myName.trim().toLowerCase();
      const isAdmin = myName.trim().toLowerCase() === "mauro di girolamo";
      const comms = getCommentiPerLocale(l.ID);

      let commentSection = "";
      if (comms.length > 0) {
        commentSection = `<div style="margin-top:10px;">${comms.map(c => `
          <div style="border-top:1px solid #eee; padding:5px;">
            <strong>${c.autore}</strong>: ${c.testo}
            ${(isAdmin || c.autore === myName) ? `<button onclick="eliminaCommento('${c.ID_commento}')" style="float:right;color:red;">x</button>` : ""}
          </div>`).join("")}</div>`;
      }

      c.innerHTML += `
        <div class="card" data-idx="${i}">
          <div>
            <strong>${l.nome}</strong> ${l.glutenFree==="si" ? "üåæüö´" : ""}<br>
            Zona: ${l.zona}<br>
            Tipo: ${l.tipo}<br>
            Voto: ${l.voto || "‚Äî"}<br>
            Consigliato da: ${l.consigliatoDa || "‚Äî"}<br>
            <a href="${l.link}" target="_blank">Link</a>
            ${commentSection}
          </div>
          <div class="actions">
            <button class="comment" onclick="aggiungiCommento('${l.ID}')">üí¨</button>
            ${(isOwner || isAdmin) ? `
              <button class="edit" onclick="modifica(${i})">‚úé</button>
              <button class="remove" onclick="rimuovi(${i})">√ó</button>` : ""}
          </div>
        </div>`;
    });
  }

  function vaiAlModulo() { document.getElementById("formAggiungi").scrollIntoView({ behavior: "smooth" }); }
async function geocodificaZonaClient(zona) {
  if (!zona) return { latitudine: "", longitudine: "" };

  const q = `Firenze, ${zona}, Italia`;

  // Tentativo 1: Nominatim ufficiale (con email nella query, niente header custom!)
  try {
    const u1 = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1&email=maurodigirola@gmail.com`;
    const r1 = await fetch(u1); // nessun header custom!
    if (r1.ok) {
      const d1 = await r1.json();
      if (Array.isArray(d1) && d1.length > 0) {
        return { latitudine: parseFloat(d1[0].lat), longitudine: parseFloat(d1[0].lon) };
      }
    }
  } catch (e) {
    console.warn("Nominatim client fallita:", e);
  }

  // Tentativo 2: geocode.maps.co (mirror OSM, spesso pi√π permissivo su CORS)
  try {
    const u2 = `https://geocode.maps.co/search?q=${encodeURIComponent(q)}&limit=1`;
    const r2 = await fetch(u2);
    if (r2.ok) {
      const d2 = await r2.json();
      if (Array.isArray(d2) && d2.length > 0) {
        return { latitudine: parseFloat(d2[0].lat), longitudine: parseFloat(d2[0].lon) };
      }
    }
  } catch (e) {
    console.warn("geocode.maps.co fallita:", e);
  }

  // Nessun risultato
  return { latitudine: "", longitudine: "" };
}


  async function aggiungi() {
  const nome = document.getElementById("nome").value.trim();
  const zona = document.getElementById("zona").value.trim();
  const tipo = document.getElementById("tipo").value.trim();
  const link = document.getElementById("link").value.trim();
  const voto = document.getElementById("voto").value;
  const glutenFree = document.getElementById("glutenFree").value;
  const commento = document.getElementById("commento").value.trim();

  if (!nome || !zona || !tipo) {
    mostraPopup("Attenzione ‚ö†Ô∏è", "Inserisci Nome, Zona e Tipo!");
    return;
  }

  mostraLoader();

  // üîπ Calcola lat/lon prima di inviare i dati al server
  const location = await geocodificaZonaClient(zona);

  const nuovo = {
    action: "add",
    nome, zona, tipo, link, voto,
    consigliatoDa: myName,
    glutenFree, commento,
    latitudine: location.latitudine,
    longitudine: location.longitudine
  };

  try {
    await fetch(SCRIPT_URL_LOCALI, {
      method: "POST",
      body: JSON.stringify(nuovo)
    });
    await carica();
    mostraPopup("Fatto!", "Locale aggiunto con successo");
  } catch (e) {
    console.error(e);
  } finally {
    nascondiLoader();
  }
}


  async function rimuovi(i) {
    if (!confirm("Vuoi eliminare questo locale?")) return;
    try {
      mostraLoader();
      await fetch(SCRIPT_URL_LOCALI, { method: "POST", body: JSON.stringify({ action: "delete", id: locali[i].ID }) });
      await carica();
      mostraPopup("Eliminato", "Locale cancellato");
    } catch (e) { console.error(e); } finally { nascondiLoader(); }
  }

  async function modifica(i) {
    const l = locali[i];
    const card = document.querySelector(`.card[data-idx="${i}"]`);
    card.innerHTML = `
      <div>
        <label>Nome:<br><input type="text" id="edit-nome-${i}" value="${l.nome}"></label><br>
        <label>Zona:<br><input type="text" id="edit-zona-${i}" value="${l.zona}"></label><br>
        <label>Tipo:<br><input type="text" id="edit-tipo-${i}" value="${l.tipo}"></label><br>
        <label>Link:<br><input type="text" id="edit-link-${i}" value="${l.link}"></label><br>
        <label>Voto:<br><input type="text" id="edit-voto-${i}" value="${l.voto || ""}"></label><br>
        <label>Gluten free:<br><input type="text" id="edit-gf-${i}" value="${l.glutenFree || ""}"></label><br>
        <label>Commento:<br><textarea id="edit-commento-${i}" rows="2">${l.commento || ""}</textarea></label>
      </div>
      <div class="actions"><button class="edit" onclick="salvaModifica(${i})">üíæ</button></div>`;
  }

  async function salvaModifica(i) {
    const loc = locali[i];
    const upd = {
      action: "update",
      id: loc.ID,
      nome: document.getElementById(`edit-nome-${i}`).value,
      zona: document.getElementById(`edit-zona-${i}`).value,
      tipo: document.getElementById(`edit-tipo-${i}`).value,
      link: document.getElementById(`edit-link-${i}`).value,
      voto: document.getElementById(`edit-voto-${i}`).value,
      glutenFree: document.getElementById(`edit-gf-${i}`).value,
      consigliatoDa: loc.consigliatoDa,
      commento: document.getElementById(`edit-commento-${i}`).value
    };
    try {
      mostraLoader();
      await fetch(SCRIPT_URL_LOCALI, { method: "POST", body: JSON.stringify(upd) });
      await carica();
      mostraPopup("Aggiornato", "Locale modificato");
    } catch (e) { console.error(e); } finally { nascondiLoader(); }
  }

  function distanza(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  async function trovaZonaPiuVicino() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) { mostraPopup("Errore", "Geolocalizzazione non supportata"); reject(); return; }
      navigator.geolocation.getCurrentPosition(
        pos => {
          userPosition = { lat: pos.coords.latitude, lon: pos.coords.longitude };
          if (zone.length === 0) { mostraPopup("Errore", "Nessuna zona disponibile"); reject(); return; }
          let best = null, min = Infinity;
          zone.forEach(z => {
            const d = distanza(userPosition.lat, userPosition.lon, z.latitudine, z.longitudine);
            if (d < min) { min = d; best = z.zona; }
          });
          resolve(best);
        },
        err => { mostraPopup("Errore", "Posizione non trovata"); reject(err); }
      );
    });
  }

  function randomLocale() {
    if (locali.length === 0) { mostraPopup("Vuoto", "Nessun locale disponibile"); return; }
    const r = locali[Math.floor(Math.random() * locali.length)];
    mostraPopup("Locale casuale üé≤", `${r.nome} (${r.tipo}, zona ${r.zona})`);
  }

  carica();
  </script>
</body>
</html>


