<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Locali Firenze 2.0</title>
  <link rel="manifest" href="manifest.json?v=3">
  <meta name="theme-color" content="#ff7e5f">

  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
    h1 { text-align: center; margin-bottom: 20px; }
    .filters { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; justify-content: center; }
    .filter-buttons { text-align: center; margin: 10px 0; }
    input, button, select, textarea { padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 1em; }
    button { background: #ff7e5f; color: white; cursor: pointer; border: none; transition: 0.3s; }
    button:hover { background: #eb5757; }
    .list { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px; max-height: 70vh; overflow-y: auto; }
    .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    .card div { max-width: 220px; word-wrap: break-word; white-space: normal; }
    .card a { color: #0077cc; text-decoration: none; }
    .actions { display: flex; flex-direction: column; align-items: center; gap: 8px; }
    .remove, .edit { border-radius: 50%; width: 30px; height: 30px; font-weight: bold; color: white; cursor: pointer; }
    .edit { background: #ffa500; }
    .remove { background: #ff4d4d; }

    /* Dropdown multi-select con checkbox */
    .dropdown { position: relative; display: inline-block; }
    .dropdown-btn {
      padding: 10px; border: 1px solid #ccc; border-radius: 8px; background: white; cursor: pointer; min-width: 180px;
    }
    .dropdown-content {
      display: none; position: absolute; background: white; border: 1px solid #ccc; border-radius: 8px; padding: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 100; max-height: 240px; overflow-y: auto; min-width: 220px;
    }
    .dropdown.show .dropdown-content { display: block; }
    .dropdown-content label { display: block; cursor: pointer; margin: 4px 0; }

    .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; }
    .popup { background:white; padding:20px; border-radius:10px; max-width:300px; text-align:center; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>

<body>
  <h1>Locali Firenze 2.0</h1>

  <!-- FILTRI -->
  <div class="filters">
    <div class="dropdown" id="zonaFilter"></div>
    <div class="dropdown" id="tipoFilter"></div>
    <div class="dropdown" id="consigliatoFilter"></div>
    <div class="dropdown" id="glutenFilter"></div>
  </div>
  <div class="filter-buttons">
    <button onclick="filtra()">Filtra</button>
    <button onclick="randomLocale()">Casuale ðŸŽ²</button>
    <button onclick="vaiAlModulo()">Aggiungi âž•</button>
  </div>
  <div class="filters">
    <input type="text" id="searchInput" placeholder="Cerca locale..." oninput="filtra()" />
  </div>

  <!-- LOADER -->
  <div id="loader" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.7); align-items:center; justify-content:center; z-index:9999;">
    <div class="spinner" style="border: 6px solid #f3f3f3; border-top: 6px solid #ff7e5f; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;"></div>
  </div>

  <!-- LISTA -->
  <div class="list" id="lista"></div>

  <!-- FORM AGGIUNTA -->
  <h2 id="formAggiungi">Aggiungi Locale</h2>
  <div class="filters">
    <input type="text" id="nome" placeholder="Nome locale">
    <input type="text" id="zona" placeholder="Zona (es. Santo Spirito)">
    <select id="tipo">
      <option value="">Tipo</option>
      <option>Pizzeria</option><option>Ristorante</option><option>Aperitivo</option><option>Cocktail bar</option><option>Paninoteca</option>
    </select>
    <input type="text" id="link" placeholder="Link Google">
    <select id="voto"><option value="">Voto</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select>
    <select id="glutenFree"><option value="">Gluten free?</option><option value="si">SÃ¬</option><option value="no">No</option></select>
    <textarea id="commento" placeholder="Commento sul locale" rows="2" style="width:100%;"></textarea>
    <button onclick="aggiungi()">Aggiungi</button>
  </div>

  <!-- POPUP GENERICO -->
  <div class="overlay" id="popupGenerico">
    <div class="popup">
      <h3 id="popupTitolo"></h3>
      <p id="popupMessaggio"></p>
      <button onclick="chiudiPopupGenerico()">OK</button>
    </div>
  </div>

  <script>
  const SCRIPT_URL_LOCALI = "https://script.google.com/macros/s/AKfycbwt6REPdUGMk02NE-VBxu8vcauaAngZ8AzexZcq1XQFmeBKaroRxOM57jKK-Of-_lcC/exec";

  let myName = localStorage.getItem("myName");
  if (!myName) {
    myName = prompt("Inserisci nome e cognome:") || "Anonimo";
    localStorage.setItem("myName", myName.trim());
  } else {
    myName = myName.trim();
  }

  let locali = [];
  let zone = []; // [{zona,lat,lon}]
  let userPosition = null;

  // util
  function mostraPopup(t, m) {
    document.getElementById("popupTitolo").textContent = t;
    document.getElementById("popupMessaggio").textContent = m;
    document.getElementById("popupGenerico").style.display = "flex";
  }
  function chiudiPopupGenerico() { document.getElementById("popupGenerico").style.display = "none"; }
  function mostraLoader() { document.getElementById("loader").style.display = "flex"; }
  function nascondiLoader() { document.getElementById("loader").style.display = "none"; }

  // chiudi dropdown clic fuori
  document.addEventListener("click", e => {
    if (!e.target.closest(".dropdown")) {
      document.querySelectorAll(".dropdown").forEach(d => d.classList.remove("show"));
    }
  });

  // carica dati
  async function carica() {
    try {
      mostraLoader();
      const res = await fetch(SCRIPT_URL_LOCALI);
      const data = await res.json();

      // normalizza proprietÃ  (gestisce sia {locali:[...]} sia array diretto e maiuscole)
      let arr = Array.isArray(data) ? data : (data.locali || []);
      locali = arr.map(o => ({
        id: o.id || o.ID,
        nome: o.nome || o.Nome || "",
        zona: o.zona || o.Zona || "",
        tipo: o.tipo || o.Tipo || "",
        link: o.link || o.Link || "",
        voto: (o.voto ?? o.Voto ?? "").toString(),
        consigliatoDa: o.consigliatoDa || o.ConsigliatoDa || "â€”",
        glutenFree: o.glutenFree || o.GlutenFree || "",
        commento: o.commento || o.Commento || "",
        lat: parseFloat(o.lat ?? o.Lat ?? o.latitudine ?? o.Latitudine ?? NaN),
        lon: parseFloat(o.lon ?? o.Lon ?? o.longitudine ?? o.Longitudine ?? NaN)
      }));

      // mappa zone con coordinate se disponibili
      const mapZone = {};
      locali.forEach(l => {
        if (l.zona && !Number.isNaN(l.lat) && !Number.isNaN(l.lon)) {
          mapZone[l.zona] = { lat: l.lat, lon: l.lon };
        }
      });
      zone = Object.entries(mapZone).map(([zona, coords]) => ({ zona, lat: coords.lat, lon: coords.lon }));

      mostra(locali);
      aggiornaFiltri();
    } catch (err) {
      console.error("Errore caricamento dati:", err);
      mostraPopup("Errore", "Impossibile caricare i dati");
    } finally {
      nascondiLoader();
    }
  }

  // render lista
  function mostra(lista) {
    const c = document.getElementById("lista");
    c.innerHTML = "";
    lista.forEach(l => {
      const isOwner = (l.consigliatoDa || "").trim().toLowerCase() === myName.toLowerCase();
      const isAdmin = myName.toLowerCase() === "mauro di girolamo";
      c.innerHTML += `
        <div class="card" data-id="${l.id}">
          <div>
            <strong>${l.nome}</strong> ${l.glutenFree==="si" ? "ðŸŒ¾ðŸš«" : ""}<br>
            Zona: ${l.zona}<br>
            Tipo: ${l.tipo}<br>
            Voto: ${l.voto || "â€”"}<br>
            Consigliato da: ${l.consigliatoDa || "â€”"}<br>
            <a href="${l.link}" target="_blank">Link</a>
          </div>
          <div class="actions">
            ${(isOwner || isAdmin) ? `
              <button class="edit" onclick="modifica('${l.id}')">âœŽ</button>
              <button class="remove" onclick="rimuovi('${l.id}')">Ã—</button>
            ` : ``}
          </div>
        </div>`;
    });
  }

  // dropdown multi-select con checkbox e "Tutti"
  function creaDropdown(id, titolo, valori) {
    const unici = [...new Set(valori)].filter(v => v);
    const div = document.getElementById(id);
    div.innerHTML = `
      <div class="dropdown-btn" data-titolo="${titolo}" onclick="toggleDropdown('${id}', event)">${titolo}</div>
      <div class="dropdown-content">
        <label><input type="checkbox" value="__ALL__" checked onchange="selezionaTutti('${id}', this)"> Tutti</label>
        ${unici.map(v => `<label><input type="checkbox" value="${v}" onchange="aggiornaTesto('${id}')"> ${v}</label>`).join("")}
      </div>
    `;
  }
  function toggleDropdown(id, event) {
    event.stopPropagation();
    document.querySelectorAll(".dropdown").forEach(d => { if (d.id !== id) d.classList.remove("show"); });
    document.getElementById(id).classList.toggle("show");
  }
  function getSelezionati(id) {
    return [...document.querySelectorAll(`#${id} .dropdown-content input:checked`)]
      .map(cb => cb.value).filter(v => v !== "__ALL__");
  }
  function selezionaTutti(id, allCb) {
    const checks = document.querySelectorAll(`#${id} .dropdown-content input[type="checkbox"]`);
    checks.forEach(cb => { if (cb !== allCb) cb.checked = false; });
    aggiornaTesto(id);
  }
  function aggiornaTesto(id) {
    const btn = document.querySelector(`#${id} .dropdown-btn`);
    const selezionati = getSelezionati(id);
    if (selezionati.length === 0) btn.textContent = btn.dataset.titolo;
    else if (selezionati.length === 1) btn.textContent = selezionati[0];
    else btn.textContent = `${selezionati.length} selezionati`;
    // deseleziona "Tutti" se selezioni altro
    const all = document.querySelector(`#${id} input[value="__ALL__"]`);
    if (all) all.checked = selezionati.length === 0;
  }

  function aggiornaFiltri() {
    const zoneValues = ["PiÃ¹ vicino a me", ...new Set(locali.map(l => l.zona).filter(Boolean))];
    creaDropdown("zonaFilter", "Tutte le zone", zoneValues);

    const tipoValues = [...new Set(locali.flatMap(l => (l.tipo || "").split("+").map(s => s.trim()).filter(Boolean)))];
    creaDropdown("tipoFilter", "Tutti i tipi", tipoValues);

    const consValues = [...new Set(locali.map(l => l.consigliatoDa || "â€”"))];
    creaDropdown("consigliatoFilter", "Tutti i consiglieri", consValues);

    const gfValues = ["si", "no"];
    creaDropdown("glutenFilter", "Gluten free", gfValues);
  }

  // distanza
  function distanza(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }
  async function trovaZonaPiuVicino() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) { mostraPopup("Errore", "Geolocalizzazione non supportata"); return reject(); }
      navigator.geolocation.getCurrentPosition(
        pos => {
          userPosition = { lat: pos.coords.latitude, lon: pos.coords.longitude };
          if (zone.length === 0) { mostraPopup("Attenzione", "Nessuna zona con coordinate disponibile"); return reject(); }
          let best = null, min = Infinity;
          zone.forEach(z => {
            const d = distanza(userPosition.lat, userPosition.lon, z.lat, z.lon);
            if (d < min) { min = d; best = z.zona; }
          });
          resolve(best);
        },
        err => { mostraPopup("Errore", "Posizione non trovata"); reject(err); }
      );
    });
  }

  // filtro
  async function filtra() {
    let zoneSel = getSelezionati("zonaFilter");
    const tipoSel = getSelezionati("tipoFilter");
    const consSel = getSelezionati("consigliatoFilter");
    const gfSel = getSelezionati("glutenFilter");
    const query = document.getElementById("searchInput").value.toLowerCase().trim();

    // gestione "PiÃ¹ vicino a me"
    if (zoneSel.includes("PiÃ¹ vicino a me")) {
      try {
        const vicina = await trovaZonaPiuVicino();
        if (vicina) {
          mostraPopup("Zona piÃ¹ vicina", `Ti trovi vicino a: ${vicina}`);
          zoneSel = [vicina];
        } else {
          zoneSel = [];
        }
      } catch {
        zoneSel = [];
      }
    }

    const f = locali.filter(l => {
      const matchZona = zoneSel.length === 0 || zoneSel.includes(l.zona);
      const tipiLoc = (l.tipo || "").split("+").map(s => s.trim()).filter(Boolean);
      const matchTipo = tipoSel.length === 0 || tipoSel.some(t => tipiLoc.includes(t));
      const matchCons = consSel.length === 0 || consSel.includes(l.consigliatoDa || "â€”");
      const matchGF = gfSel.length === 0 || gfSel.includes(l.glutenFree || "");
      const matchQuery = !query || (l.nome || "").toLowerCase().includes(query);
      return matchZona && matchTipo && matchCons && matchGF && matchQuery;
    });

    mostra(f);
  }

  // azioni
  function vaiAlModulo() { document.getElementById("formAggiungi").scrollIntoView({ behavior: "smooth" }); }

  async function aggiungi() {
    const vNome = document.getElementById("nome").value.trim();
    const vZona = document.getElementById("zona").value.trim();
    const vTipo = document.getElementById("tipo").value.trim();
    const vLink = document.getElementById("link").value.trim();
    const vVoto = document.getElementById("voto").value;
    const vGF = document.getElementById("glutenFree").value;
    const vComm = document.getElementById("commento").value.trim();

    if (!vNome || !vZona || !vTipo) {
      mostraPopup("Attenzione", "Inserisci Nome, Zona e Tipo");
      return;
    }

    const payload = {
      action: "add",
      nome: vNome, zona: vZona, tipo: vTipo, link: vLink,
      voto: vVoto, consigliatoDa: myName, glutenFree: vGF, commento: vComm
    };

    try {
      mostraLoader();
      await fetch(SCRIPT_URL_LOCALI, { method: "POST", body: JSON.stringify(payload) });
      await carica();
      mostraPopup("Fatto!", "Locale aggiunto");
      // pulizia campi
      document.getElementById("nome").value = "";
      document.getElementById("zona").value = "";
      document.getElementById("tipo").value = "";
      document.getElementById("link").value = "";
      document.getElementById("voto").value = "";
      document.getElementById("glutenFree").value = "";
      document.getElementById("commento").value = "";
    } catch (e) {
      console.error(e);
      mostraPopup("Errore", "Impossibile aggiungere il locale");
    } finally {
      nascondiLoader();
    }
  }

  async function rimuovi(id) {
    if (!confirm("Vuoi eliminare questo locale?")) return;
    try {
      mostraLoader();
      await fetch(SCRIPT_URL_LOCALI, { method: "POST", body: JSON.stringify({ action: "delete", id }) });
      await carica();
      mostraPopup("Eliminato", "Locale cancellato");
    } catch (e) {
      console.error(e);
      mostraPopup("Errore", "Impossibile cancellare il locale");
    } finally {
      nascondiLoader();
    }
  }

  function modifica(id) {
    const l = locali.find(x => x.id === id);
    if (!l) return;

    const card = document.querySelector(`.card[data-id="${id}"]`);
    card.innerHTML = `
      <div>
        <label>Nome:<br><input type="text" id="edit-nome-${id}" value="${l.nome}"></label><br>
        <label>Zona:<br><input type="text" id="edit-zona-${id}" value="${l.zona}"></label><br>
        <label>Tipo:<br><input type="text" id="edit-tipo-${id}" value="${l.tipo}"></label><br>
        <label>Link:<br><input type="text" id="edit-link-${id}" value="${l.link}"></label><br>
        <label>Voto:<br>
          <select id="edit-voto-${id}">
            <option value="" ${!l.voto?"selected":""}></option>
            ${[1,2,3,4,5].map(v => `<option value="${v}" ${String(l.voto)===String(v)?"selected":""}>${v}</option>`).join("")}
          </select>
        </label><br>
        <label>Gluten free:<br>
          <select id="edit-gf-${id}">
            <option value="" ${!l.glutenFree?"selected":""}></option>
            <option value="si" ${l.glutenFree==="si"?"selected":""}>SÃ¬</option>
            <option value="no" ${l.glutenFree==="no"?"selected":""}>No</option>
          </select>
        </label><br>
        <label>Commento:<br><textarea id="edit-commento-${id}" rows="2" style="width:100%">${l.commento || ""}</textarea></label>
      </div>
      <div class="actions">
        <button class="edit" onclick="salvaModifica('${id}')">ðŸ’¾</button>
      </div>`;
  }

  async function salvaModifica(id) {
    const upd = {
      action: "update",
      id,
      nome: document.getElementById(`edit-nome-${id}`).value,
      zona: document.getElementById(`edit-zona-${id}`).value,
      tipo: document.getElementById(`edit-tipo-${id}`).value,
      link: document.getElementById(`edit-link-${id}`).value,
      voto: document.getElementById(`edit-voto-${id}`).value,
      glutenFree: document.getElementById(`edit-gf-${id}`).value,
      commento: document.getElementById(`edit-commento-${id}`).value,
      // manteniamo consigliatoDa originale lato server se serve
    };
    try {
      mostraLoader();
      await fetch(SCRIPT_URL_LOCALI, { method: "POST", body: JSON.stringify(upd) });
      await carica();
      mostraPopup("Aggiornato", "Locale modificato");
    } catch (e) {
      console.error(e);
      mostraPopup("Errore", "Impossibile modificare il locale");
    } finally {
      nascondiLoader();
    }
  }

  // random
  function randomLocale() {
    if (!locali.length) return mostraPopup("Vuoto", "Nessun locale disponibile");
    const r = locali[Math.floor(Math.random() * locali.length)];
    mostraPopup("Locale casuale ðŸŽ²", `${r.nome} (${r.tipo}, zona ${r.zona})`);
  }

  carica();
  </script>
</body>
</html>
