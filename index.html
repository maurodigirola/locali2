


<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Locali Firenze</title>
	<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ff7e5f">

  <style>


    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
    h1 { text-align: center; margin-bottom: 20px; }
    .filters { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; justify-content: center; }
    .filter-buttons { text-align: center; margin: 10px 0; }
    input, button, select, textarea { padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 1em; }
    button { background: #ff7e5f; color: white; cursor: pointer; border: none; transition: 0.3s; }
    button:hover { background: #eb5757; }
    .list { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
      gap: 10px; 
      max-height: 70vh; 
      overflow-y: auto; 
      padding-right: 5px; 
    }
    .card { 
      background: white; padding: 15px; border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
      display: flex; justify-content: space-between; align-items: center;
    }
    .card div {
      max-width: 220px;
      word-wrap: break-word;
      white-space: normal;
    }
    .card a { color: #0077cc; text-decoration: none; }
.actions {
  display: flex;
  flex-direction: column;
  align-items: center; /* centra tutti i bottoni nella colonna */
  gap: 8px;
}
    .remove { background: #ff4d4d; border: none; border-radius: 50%; color: white; font-weight: bold; width: 30px; height: 30px; cursor: pointer; }
    .edit { background: #ffa500; border: none; border-radius: 50%; color: white; font-weight: bold; width: 30px; height: 30px; cursor: pointer; }
.comment {
  background: #ff9966; /* puoi cambiare colore */
  border: none;
  border-radius: 50%;
  color: white;
  font-weight: bold;
  width: 30px;
  height: 30px;
  cursor: pointer;
}


.star {
  background: none;
  border: none;
  font-size: 22px;
  cursor: pointer;
  color: gold;
  transition: transform 0.2s;
}
.star:hover {
  transform: scale(1.2);
}

.star.preferito {
  color: #ffcc00;             /* giallo pi√π acceso */
  text-shadow: 0 0 4px #ffcc00; /* leggero bagliore */
  transform: scale(1.1);      /* leggermente pi√π grande */
}
    .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6);
      display:none; justify-content:center; align-items:center; }
    .popup { background:white; padding:20px; border-radius:10px; max-width:300px; text-align:center; }
    .menu { position: relative; display: inline-block; }
    .menu-content {
      display: none; position: absolute; right:0;
      background: white; border: 1px solid #ccc;
      border-radius: 8px; padding: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 100;
    }
    .menu-content button {
      display: block; width: 100%; margin: 5px 0; 
      background: #ff7e5f; color: white;
    }
    .menu.show .menu-content { display: block; }

    /* --- Dropdown multi-select --- */
    .dropdown { position: relative; display: inline-block; }
    .dropdown-btn {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      min-width: 150px;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 100;
      max-height: 200px;
      overflow-y: auto;
    }
    .dropdown.show .dropdown-content { display: block; }
    .dropdown-content label { display: block; cursor: pointer; margin: 3px 0; }

    .tipo-wrapper { display: flex; align-items: center; gap: 5px; margin-bottom: 5px; }
    .tipo-wrapper button { background: #ff4d4d; border-radius: 6px; padding: 5px 10px; }
.edit, .remove, .comment {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  line-height: 1;
  padding: 0;
}
.comment-container {
  display: flex;
  align-items: center;
  justify-content: center;
}

.comment-count {
  margin-right: 6px;   /* spazio tra numero e nuvoletta */
  font-weight: bold;
  color: #ff7e5f;
  font-size: 14px;
  min-width: 14px;
  text-align: right;
}

.comment-container .comment-count {
  font-weight: bold;
  color: #ff7e5f;
  font-size: 14px;
}


  </style>
</head>
	
<body>
  <h1>Locali Firenze</h1>

  <!-- FILTRI -->
  <div class="filters">
    <div class="dropdown" id="zonaFilter"></div>
    <div class="dropdown" id="tipoFilter"></div>
    <div class="dropdown" id="consigliatoFilter"></div>
    <div class="dropdown" id="glutenFilter"></div>
  </div>
  <div class="filter-buttons">
    <button onclick="filtra()">Filtra</button><br><br>
    <button onclick="randomLocale()">Casuale üé≤</button>
<button onclick="vaiAlModulo()">Aggiungi ‚ûï</button>
<div class="menu">
  <button onclick="toggleMenu(event)">‚ãÆ Altro</button>
  <div id="extraMenu" class="menu-content">
    <button onclick="condividiWhatsapp();chiudiMenu()">Condividi con un amico üì≤</button>
    <button style="background:#4CAF50;" onclick="window.location.href='https://maurodigirola.github.io/sondaggio/'; chiudiMenu()">Crea sondaggio üìù</button>
    <button style="background:#0077cc;" onclick="window.open('https://www.firenzetoday.it/eventi/', '_blank'); chiudiMenu()">Eventi a Firenze üìÖ</button>
	  <button id="installButton" style="display:none; background:#ff7e5f;" onclick="installApp()">Installa app üì≤</button>

  </div>
</div>



    </div>
  </div>
<!-- BARRA DI RICERCA -->
<div class="filters">
  <input type="text" id="searchInput" placeholder="Cerca locale..." oninput="cercaPerNome()">
</div>






<div id="loader" style="
  display:none;
  position:fixed;
  top:0; left:0; width:100%; height:100%;
  background:rgba(255,255,255,0.7);
  align-items:center; justify-content:center;
  z-index:9999;">
  <div class="spinner" style="
    border: 6px solid #f3f3f3;
    border-top: 6px solid #ff7e5f;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;">
  </div>
</div>


<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>








  <!-- LISTA -->
  <div class="list" id="lista"></div>

  <!-- FORM AGGIUNTA -->
  <h2 id="formAggiungi">Aggiungi Locale</h2>
  <div class="filters">
    <input type="text" id="nome" placeholder="Nome locale">
    <input type="text" id="zona" placeholder="Zona (es. Santo Spirito)">
    <div id="tipo-container">
      <div class="tipo-wrapper">
        <select class="tipo" onchange="aggiornaOpzioniTipo()">
          <option value="">Tipo</option>
          <option>Pizzeria</option>
          <option>Ristorante</option>
          <option>Aperitivo</option>
          <option>Cocktail bar</option>
	<option>Paninoteca</option>


        </select>
      </div>
      <button type="button" onclick="aggiungiCampoTipo()">+</button>
    </div>
    <input type="text" id="link" placeholder="Link Google">
    <select id="voto">
      <option value="">Voto</option>
      <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
    </select>
    <select id="glutenFree">
      <option value="">Gluten free?</option>
      <option value="si">S√¨</option>
      <option value="no">No</option>
    </select>
    <textarea id="commento" placeholder="Commento sul locale" rows="2" style="width:100%;"></textarea>
    <button onclick="aggiungi()">Aggiungi</button>
  </div>

  <!-- POPUP IMPORT -->
  <div class="overlay" id="overlay">
    <div class="popup">
      <h3>Scegli consiglieri da importare</h3>
      <div id="checkboxes"></div>
      <button onclick="confermaImport()">Importa selezionati</button>
      <button onclick="chiudiPopup()">Annulla</button>
    </div>
  </div>

  <!-- POPUP LOCALE AGGIUNTO -->
  <div class="overlay" id="popupAggiunto">
    <div class="popup">
      <h3>Locale aggiunto!</h3>
      <button onclick="chiudiPopupAggiunto()">OK</button>
    </div>
  </div>

  <!-- POPUP COMMENTO -->
  <div class="overlay" id="popupCommento">
    <div class="popup">
      <h3>Commento</h3>
      <p id="testoCommento"></p>
      <button onclick="chiudiCommento()">Chiudi</button>
    </div>
  </div>

<!-- POPUP LOCALE MODIFICATO -->
<div class="overlay" id="popupModificato">
  <div class="popup">
    <h3>Locale modificato!</h3>
    <button onclick="chiudiPopupModificato()">OK</button>
  </div>
</div>

<!-- POPUP LOCALE CANCELLATO -->
<div class="overlay" id="popupCancellato">
  <div class="popup">
    <h3>Locale cancellato!</h3>
    <button onclick="chiudiPopupCancellato()">OK</button>
  </div>
</div>

<!-- POPUP COMMENTI MULTIPLI -->
<div class="overlay" id="popupCommenti">
  <div class="popup" style="max-width:400px; text-align:left;">
    <h3>Commenti</h3>
    <div id="listaCommenti" style="max-height:200px; overflow-y:auto; margin-bottom:10px;"></div>
    <textarea id="nuovoCommento" placeholder="Scrivi un commento..." rows="3" style="width:100%;"></textarea>
    <button onclick="aggiungiCommento()">Aggiungi commento</button>
    <button onclick="chiudiCommenti()">Chiudi</button>
  </div>
</div>
	
<!-- POPUP GENERICO -->
<div class="overlay" id="popupGenerico">
  <div class="popup">
    <h3 id="popupTitolo"></h3>
    <p id="popupMessaggio"></p>
    <button onclick="chiudiPopupGenerico()">OK</button>
  </div>
</div>

  <script>
// Endpoint esistente per i locali
const SCRIPT_URL_LOCALI = "https://script.google.com/macros/s/AKfycbyf88jHp8K5e9eZEkoE6mtauZEnpGyiWOAv0rkgLPoPg4MbailJOAPuUuuYjbiVcjUl/exec";

// Endpoint nuovo per i commenti
const SCRIPT_URL_COMMENTI = "https://script.google.com/macros/s/AKfycbz4TW5Ixv7uSjhtG_nsoDku0P0TxrbWsFFRmwNdWxxRJfCCW_lbwCP59CG6P9eysfRzVA/exec";

const SCRIPT_URL_PREFERITI = "https://script.google.com/macros/s/AKfycbzZ2eGEMUY9Y_iUdNFfZ75JZ5ebDx8Cyb2gLk1wP2k7PyiajX0gHkwnPLK84PUJeBjx/exec";


    let myName = localStorage.getItem("myName");
  if (!myName) {
  myName = prompt("Inserisci nome e cognome:");
  if (myName) {
    myName = myName.trim();
    localStorage.setItem("myName", myName);
  } else {
    myName = "Anonimo";
  }
}
    let locali = [];

    function salva() { localStorage.setItem("locali", JSON.stringify(locali)); }
async function carica() {
  try {
    mostraLoader();

    // scarica locali e commenti in parallelo
const [resLocali, resCommenti, resPreferiti] = await Promise.all([
  fetch(SCRIPT_URL_LOCALI),
  fetch(SCRIPT_URL_COMMENTI),
  fetch(SCRIPT_URL_PREFERITI)
]);

    locali = await resLocali.json();
    const commenti = await resCommenti.json();
const preferitiData = await resPreferiti.json();
// preferitiData √® un array di oggetti { nome, zona, consigliatoDa, autore, data }
preferiti = preferitiData
  // preferiti soltanto quelli che hai aggiunto tu (opzionale: puoi filtrare per autore = myName)
  .filter(p => p.autore && p.autore.trim().toLowerCase() === myName.trim().toLowerCase())
  .map(p => `${p.nome.toLowerCase()}|${p.zona.toLowerCase()}|${(p.consigliatoDa || "‚Äî").toLowerCase()}`);


    // associa i commenti ai locali
    locali.forEach(l => l.commenti = []);
    commenti.forEach(c => {
     const loc = locali.find(l =>
  l.nome.trim().toLowerCase() === c.locale.trim().toLowerCase() &&
  l.zona.trim().toLowerCase() === c.zona.trim().toLowerCase()
);

      if (loc) {
        loc.commenti.push({
          autore: c.autore,
          data: c.data,
          testo: c.testo
        });
      }
    });

    mostra();

  } catch (err) {
    console.error("Errore caricamento dati:", err);
  } finally {
    nascondiLoader();
  }
}

let preferiti = []; // verr√† popolato dal Web App

async function togglePreferito(nome, zona, consigliatoDa) {
  const body = {
    nome,
    zona,
    consigliatoDa,    // chi ha inserito il locale
    autore: myName,    // tu che fai preferito
    action: "addFavorite"
  };

  if (isPreferito(nome, zona, consigliatoDa)) {
    body.action = "removeFavorite";
  }

  try {
    await fetch(SCRIPT_URL_PREFERITI, {
      method: "POST",
      body: JSON.stringify(body)
    });

    if (body.action === "addFavorite") {
      mostraPopup("Aggiunto ai tuoi locali", "‚≠ê Salvato nei preferiti online!");
    }

    // Ricarica tutti i dati (locali, commenti, preferiti)
    await carica();

  } catch (err) {
    console.error("Errore preferito:", err);
    mostraPopup("Errore ‚ùå", "Impossibile salvare il preferito online.");
  }
}

function isPreferito(nome, zona, consigliatoDa) {
  const id = `${nome.toLowerCase()}|${zona.toLowerCase()}|${(consigliatoDa || "‚Äî").toLowerCase()}`;
  return preferiti.includes(id);
}





function mostraPopup(titolo, messaggio) {
  document.getElementById("popupTitolo").textContent = titolo || "";
  document.getElementById("popupMessaggio").textContent = messaggio || "";
  document.getElementById("popupGenerico").style.display = "flex";
}

function chiudiPopupGenerico() {
  document.getElementById("popupGenerico").style.display = "none";
}


function chiudiPopupModificato() {
  document.getElementById("popupModificato").style.display = "none";
}
function condividiWhatsapp() {
  const text = encodeURIComponent("Ciao üëã prova anche tu questa app dei locali di Firenze! üçïüç∑\n\nhttps://maurodigirola.github.io/locali/Locali_Firenze_04.html");
  window.open(`https://wa.me/?text=${text}`, "_blank");
}


function chiudiPopupCancellato() {
  document.getElementById("popupCancellato").style.display = "none";
}


    const tipiDisponibili = ["Pizzeria","Ristorante","Aperitivo","Cocktail bar","Paninoteca"];


    function aggiungiCampoTipo() {
      const container = document.getElementById("tipo-container");
      const selects = container.querySelectorAll("select");
      if (selects.length >= 4) {
      mostraPopup("Limite raggiunto", "Puoi aggiungere al massimo 4 tipi");
        return;
      }
      const div = document.createElement("div");
      div.className = "tipo-wrapper";
      div.innerHTML = `
        <select class="tipo" onchange="aggiornaOpzioniTipo()"></select>
        <button type="button" onclick="rimuoviCampoTipo(this)">‚ùå</button>
      `;
      container.insertBefore(div, container.lastElementChild);
      aggiornaOpzioniTipo();
    }
function vaiAlModulo() {
  document.getElementById("formAggiungi").scrollIntoView({ behavior: "smooth" });
}




function mostraLoader() {
  document.getElementById("loader").style.display = "flex";
}

function nascondiLoader() {
  document.getElementById("loader").style.display = "none";
}





    function rimuoviCampoTipo(btn) {
      btn.parentElement.remove();
      aggiornaOpzioniTipo();
    }

    function aggiornaOpzioniTipo() {
      const selects = document.querySelectorAll("#tipo-container select");
      const selezionati = [...selects].map(s => s.value).filter(v => v);
      selects.forEach(select => {
        const valoreAttuale = select.value;
        select.innerHTML = `<option value="">Tipo</option>` +
          tipiDisponibili
            .filter(t => !selezionati.includes(t) || t === valoreAttuale)
            .map(t => `<option ${t===valoreAttuale?"selected":""}>${t}</option>`)
            .join("");
      });
    }

    function creaDropdown(id, titolo, valori) {
      const unici = [...new Set(valori.flatMap(v => v.split("+")))].filter(v => v);
      const div = document.getElementById(id);
      div.innerHTML = `
        <div class="dropdown-btn" data-titolo="${titolo}" onclick="toggleDropdown('${id}', event)">${titolo}</div>
        <div class="dropdown-content">
          <label><input type="checkbox" value="__ALL__" checked onchange="selezionaTutti('${id}', this)"> Tutti</label>
          ${unici.map(v => `<label><input type="checkbox" value="${v}" onchange="aggiornaTesto('${id}')"> ${v}</label>`).join("")}
        </div>
      `;
    }
// --- Ricerca per nome ---
function cercaPerNome() {
  const query = document.getElementById("searchInput").value.toLowerCase().trim();
  const filtrati = locali.filter(l => l.nome.toLowerCase().includes(query));
  mostra(filtrati);
}

function aggiornaFiltri() {
  // Ordina le zone alfabeticamente
  const zone = [...new Set(locali.map(l => l.zona.trim()))].sort((a,b)=>a.localeCompare(b));

  // Tipi invariati
  const tipi = locali.map(l => l.tipo);

  // Consiglieri ordinati alfabeticamente
  const cons = [...new Set(locali.map(l => (l.consigliatoDa || "‚Äî").trim()))]
                .sort((a,b)=>a.localeCompare(b));

  // "Miei locali" sempre come prima voce
  const safeName = (myName || "").trim().toLowerCase();
  const consWithMine = [
    "Miei locali",
    ...cons.filter(c => (c || "").trim().toLowerCase() !== safeName)
  ];

  // Gluten free invariato
  const gf = ["si", "no"];

  // Crea i dropdown
  creaDropdown("zonaFilter", "Tutte le zone", zone);
  creaDropdown("tipoFilter", "Tutti i tipi", tipi);
  creaDropdown("consigliatoFilter", "Tutti i consiglieri", consWithMine);
  creaDropdown("glutenFilter", "Gluten free", gf);
}


    function toggleDropdown(id, event) {
      event.stopPropagation();
      document.querySelectorAll(".dropdown").forEach(d => { if (d.id !== id) d.classList.remove("show"); });
      document.getElementById(id).classList.toggle("show");
    }

    function aggiornaTesto(id) {
      const btn = document.querySelector(`#${id} .dropdown-btn`);
      const selezionati = getSelezionati(id).filter(v => v !== "__ALL__");
      if (selezionati.length === 0) { btn.textContent = btn.dataset.titolo; document.querySelector(`#${id} input[value="__ALL__"]`).checked = true; }
      else if (selezionati.length === 1) { btn.textContent = selezionati[0]; document.querySelector(`#${id} input[value="__ALL__"]`).checked = false; }
      else { btn.textContent = selezionati.length + " selezionati"; document.querySelector(`#${id} input[value="__ALL__"]`).checked = false; }
    }
    function selezionaTutti(id) {
      const inputs = document.querySelectorAll(`#${id} .dropdown-content input[type="checkbox"]`);
      inputs.forEach(cb => { if (cb.value !== "__ALL__") cb.checked = false; });
      aggiornaTesto(id);
    }

    document.addEventListener("click", function(e) {
      if (!e.target.closest(".dropdown")) document.querySelectorAll(".dropdown").forEach(d => d.classList.remove("show"));
      if (!e.target.closest(".menu")) document.querySelectorAll(".menu").forEach(m => m.classList.remove("show"));
    });

function mostra(lista = locali) {
  aggiornaFiltri();
  const c = document.getElementById("lista");
  c.innerHTML = "";
  lista.forEach((loc) => {
    const idxGlobale = locali.findIndex(x => 
      x.nome === loc.nome &&
      x.zona === loc.zona &&
      (x.consigliatoDa || "‚Äî") === (loc.consigliatoDa || "‚Äî")
    );

    // Controlli permessi
   const isOwner = (loc.consigliatoDa || "").trim().toLowerCase() === myName.trim().toLowerCase();

   const isAdmin = myName.trim().toLowerCase() === "mauro di girolamo";


    // Conta i commenti
    const numCommenti = loc.commenti ? loc.commenti.length : 0;

    // Costruzione HTML
c.innerHTML += `
  <div class="card" data-idx="${idxGlobale}">
    <div>



      <strong>${loc.nome}</strong> ${loc.glutenFree==="si" ? "üåæüö´" : ""}<br>
      Zona: ${loc.zona} <br>
      Tipo: ${loc.tipo} <br>
      Voto: ${loc.voto || "‚Äî"}<br>
      Consigliato da: ${loc.consigliatoDa || "‚Äî"}<br>
      <a href="${loc.link}" target="_blank">Link</a>
    </div>

    <div class="actions">

      <!-- STELLA DEI PREFERITI -->
<button class="star ${isPreferito(loc.nome,loc.zona,loc.consigliatoDa) ? 'preferito' : ''}"
  title="Aggiungi ai preferiti"
onclick="togglePreferito(
  '${loc.nome.replace(/'/g, '&#39;')}',
  '${loc.zona.replace(/'/g, '&#39;')}',
  '${(loc.consigliatoDa||'').replace(/'/g, '&#39;')}'
)">
  ${isPreferito(loc.nome,loc.zona,loc.consigliatoDa) ? "\u2B50" : "\u2606"}
</button>

      <!-- PULSANTI EDIT/REMOVE (solo per chi ha aggiunto o admin) -->
      ${
        (isOwner || isAdmin)
          ? `
            <button class="edit" onclick="modifica(${idxGlobale})">‚úé</button>
            <button class="remove" onclick="rimuovi(${idxGlobale})">√ó</button>
          `
          : ""
      }

      <!-- COMMENTI -->
      <div class="comment-container">
        <button class="comment" title="Commenti" onclick="apriCommenti(${idxGlobale})">üí¨</button>
        <span class="comment-count">${loc.commenti ? loc.commenti.length : 0}</span>
      </div>
    </div>
  </div>`;


  }); // chiude forEach
} // chiude funzione mostra


async function aggiungi() {
  const nome = document.getElementById("nome").value.trim();
  const zona = document.getElementById("zona").value.trim();
  const tipoElements = document.querySelectorAll("#tipo-container select");
  const tipi = [...tipoElements].map(s => s.value).filter(v => v);
  const link = document.getElementById("link").value.trim();
  const voto = document.getElementById("voto").value;
  const glutenFree = document.getElementById("glutenFree").value;
  const commento = document.getElementById("commento").value.trim();

  if (!nome || !zona || tipi.length === 0) {
    mostraPopup("Attenzione ‚ö†Ô∏è", "Devi inserire Nome, Zona e almeno un Tipo!");
    return;
  }

  const nuovo = {
    action: "add",
    nome, zona, tipo: tipi.join("+"), link, voto,
    consigliatoDa: myName, glutenFree, commento
  };

  try {
    mostraLoader();

    // 1Ô∏è‚É£ salva il locale nel foglio dei locali
    await fetch(SCRIPT_URL_LOCALI, {
      method: "POST",
      body: JSON.stringify(nuovo)
    });

    // 2Ô∏è‚É£ se c‚Äô√® un commento, salvalo nel foglio dei commenti
    if (commento) {
      const nuovoCommento = {
        action: "addComment",
        locale: nome,
        zona: zona,
        commento: {
          autore: myName,
          data: new Date().toLocaleString("it-IT"),
          testo: commento
        }
      };

      await fetch(SCRIPT_URL_COMMENTI, {
        method: "POST",
        body: JSON.stringify(nuovoCommento)
      });
    }

    // 3Ô∏è‚É£ aggiorna UI
    document.getElementById("popupAggiunto").style.display = "flex";
    carica();

    // pulizia campi
    document.getElementById("nome").value = "";
    document.getElementById("zona").value = "";
    document.getElementById("tipo-container").innerHTML = `
      <div class="tipo-wrapper">
        <select class="tipo" onchange="aggiornaOpzioniTipo()">
          <option value="">Tipo</option>
          <option>Pizzeria</option>
          <option>Ristorante</option>
          <option>Aperitivo</option>
          <option>Cocktail bar</option>
          <option>Paninoteca</option>
        </select>
      </div>
      <button type="button" onclick="aggiungiCampoTipo()">+</button>
    `;
    document.getElementById("link").value = "";
    document.getElementById("voto").value = "";
    document.getElementById("glutenFree").value = "";
    document.getElementById("commento").value = "";

  } catch (err) {
    console.error("Errore invio dati:", err);
    mostraPopup("Errore ‚ùå", "Problema durante il salvataggio del locale o del commento!");
  } finally {
    nascondiLoader();
  }
}


    // --- Modifica ---
function modifica(i) {
  const loc = locali[i];
  const tipi = loc.tipo.split("+"); 
  const card = document.querySelector(`.card[data-idx="${i}"]`); // qui la differenza

  let tipoHTML = tipi.map((t, idx) => `
    <div class="tipo-wrapper">
      <select class="edit-tipo" data-index="${idx}">
        <option value="">Tipo</option>
        <option ${t==="Pizzeria"?"selected":""}>Pizzeria</option>
        <option ${t==="Ristorante"?"selected":""}>Ristorante</option>
        <option ${t==="Aperitivo"?"selected":""}>Aperitivo</option>
        <option ${t==="Cocktail bar"?"selected":""}>Cocktail bar</option>
        <option ${t==="Paninoteca"?"selected":""}>Paninoteca</option>
      </select>
      ${idx>0 ? `<button type="button" onclick="this.parentElement.remove()">‚ùå</button>` : ""}
    </div>
  `).join("");

  card.innerHTML = `
    <div>
      <label>Nome:<br><input type="text" id="edit-nome-${i}" value="${loc.nome}"></label><br>
      <label>Zona:<br><input type="text" id="edit-zona-${i}" value="${loc.zona}"></label><br>
      <label>Tipo:<br>
        <div id="edit-tipo-container-${i}">
          ${tipoHTML}
        </div>
        <button type="button" onclick="aggiungiCampoTipoEdit(${i})">+</button>
      </label><br>
      <label>Link:<br><input type="text" id="edit-link-${i}" value="${loc.link}"></label><br>
      <label>Voto:<br>
        <select id="edit-voto-${i}">
          <option value="" ${!loc.voto?"selected":""}></option>
          <option value="1" ${loc.voto==="1"?"selected":""}>1</option>
          <option value="2" ${loc.voto==="2"?"selected":""}>2</option>
          <option value="3" ${loc.voto==="3"?"selected":""}>3</option>
          <option value="4" ${loc.voto==="4"?"selected":""}>4</option>
          <option value="5" ${loc.voto==="5"?"selected":""}>5</option>
        </select>
      </label><br>
      <label>Gluten free:<br>
        <select id="edit-gf-${i}">
          <option value="" ${!loc.glutenFree?"selected":""}></option>
          <option value="si" ${loc.glutenFree==="si"?"selected":""}>S√¨</option>
          <option value="no" ${loc.glutenFree==="no"?"selected":""}>No</option>
        </select>
      </label><br>
      <label>Consigliato da:<br><input type="text" id="edit-cons-${i}" value="${loc.consigliatoDa}"></label><br>
      <label>Commento:<br><textarea id="edit-commento-${i}" rows="2" style="width:100%">${loc.commento || ""}</textarea></label>
    </div>
    <div class="actions">
      <button class="edit" onclick="salvaModifica(${i})">üíæ</button>
    </div>`;
}


function aggiungiCampoTipoEdit(i) {
  const container = document.getElementById(`edit-tipo-container-${i}`);
  const selects = container.querySelectorAll("select");
  if (selects.length >= 4) {
   mostraPopup("Limite raggiunto", "Puoi aggiungere al massimo 4 tipi");

    return;
  }
  const div = document.createElement("div");
  div.className = "tipo-wrapper";
  div.innerHTML = `
    <select class="edit-tipo">
      <option value="">Tipo</option>
      <option>Pizzeria</option>
      <option>Ristorante</option>
      <option>Aperitivo</option>
      <option>Cocktail bar</option>
    </select>
    <button type="button" onclick="this.parentElement.remove()">‚ùå</button>
  `;
  container.appendChild(div);
}

async function salvaModifica(i) {
  const tipoElements = document.querySelectorAll(`#edit-tipo-container-${i} select`);
  const tipi = [...tipoElements].map(s => s.value).filter(v => v);

  const locVecchio = locali[i]; // locale originale prima della modifica

  const aggiornato = {
    action: "update",
    oldNome: locVecchio.nome,   // üëà aggiungo il vecchio nome
    nome: document.getElementById(`edit-nome-${i}`).value,
    zona: document.getElementById(`edit-zona-${i}`).value,
    tipo: tipi.join("+"),
    link: document.getElementById(`edit-link-${i}`).value,
    voto: document.getElementById(`edit-voto-${i}`).value,
    glutenFree: document.getElementById(`edit-gf-${i}`).value,
    consigliatoDa: document.getElementById(`edit-cons-${i}`).value,
    commento: document.getElementById(`edit-commento-${i}`).value
  };

  try {
    mostraLoader();
   await fetch(SCRIPT_URL_LOCALI, {
  method: "POST",
  body: JSON.stringify(aggiornato)
});

    nascondiLoader();
    await carica();
    document.getElementById("popupModificato").style.display = "flex";
  } catch (err) {
    console.error("Errore aggiornamento dati:", err);
    nascondiLoader();
  }
}





    // --- Rimuovi ---
async function rimuovi(i) {
  if(confirm("Vuoi eliminare questo locale?")) {
    const nome = locali[i].nome;
    try {
      mostraLoader();
   await fetch(SCRIPT_URL_LOCALI, {
  method: "POST",
  body: JSON.stringify({ action: "delete", nome })
});

      nascondiLoader();
      await carica();
      document.getElementById("popupCancellato").style.display = "flex";
    } catch (err) {
      console.error("Errore eliminazione dati:", err);
      nascondiLoader();
    }
  }
}



    // --- Commento ---


let localeSelezionato = null;

function apriCommenti(idx) {
  localeSelezionato = idx; // ricordo quale locale √® stato cliccato
  const loc = locali[idx];

  // Se il locale non ha ancora commenti, inizializza un array vuoto
  if (!loc.commenti) loc.commenti = [];

  // Mostra la lista dei commenti
  const div = document.getElementById("listaCommenti");
  if (loc.commenti.length === 0) {
    div.innerHTML = "<p>Nessun commento ancora.</p>";
  } else {
    div.innerHTML = loc.commenti
  .sort((a, b) => new Date(b.data) - new Date(a.data)) // ordina per data decrescente
  .map(c => `
    <div style="margin-bottom:8px; border-bottom:1px solid #ccc; padding-bottom:5px;">
      <strong>${c.autore}</strong> <small>${c.data}</small><br>
      ${c.testo}
    </div>
  `).join("");

  }


  // Pulisce il campo nuovo commento
  document.getElementById("nuovoCommento").value = "";

  // Mostra il popup
  document.getElementById("popupCommenti").style.display = "flex";
}

function chiudiCommenti() {
  document.getElementById("popupCommenti").style.display = "none";
}
async function aggiungiCommento() {

  const testo = document.getElementById("nuovoCommento").value.trim();
  if (!testo) {
 mostraPopup("Attenzione ‚ö†Ô∏è", "Scrivi un commento prima di aggiungerlo!");
    return;
  }

  const loc = locali[localeSelezionato];
  if (!loc.commenti) loc.commenti = [];

  const nuovo = {
    autore: myName,
    data: new Date().toLocaleString("it-IT"),
    testo: testo
  };

  try {
    mostraLoader();
    await fetch(SCRIPT_URL_COMMENTI, {
      method: "POST",
      body: JSON.stringify({
        action: "addComment",
        locale: loc.nome,
        zona: loc.zona,
        commento: nuovo
      })
    });

    // aggiorna in locale
    loc.commenti.push(nuovo);

    // aggiorna la lista nel popup
    document.getElementById("listaCommenti").innerHTML = loc.commenti
      .map(c => `
        <div style="margin-bottom:8px; border-bottom:1px solid #ccc; padding-bottom:5px;">
          <strong>${c.autore}</strong> <small>${c.data}</small><br>
          ${c.testo}
        </div>
      `).join("");

    document.getElementById("nuovoCommento").value = "";

// üîπ aggiorna il contatore accanto alla nuvoletta
const span = document.querySelector(`.card[data-idx="${localeSelezionato}"] .comment-count`);
if (span) {
  span.textContent = loc.commenti.length;
}


  } catch (err) {
    console.error("Errore salvataggio commento:", err);
 mostraPopup("Errore ‚ùå", "Errore durante il salvataggio del commento!");

  } finally {
    nascondiLoader();
  }
}




    function chiudiCommento() {
      document.getElementById("popupCommento").style.display = "none";
    }

    // --- Filtra ---
    function getSelezionati(id) {
      return [...document.querySelectorAll(`#${id} .dropdown-content input:checked`)]
        .map(cb => cb.value)
        .filter(v => v !== "__ALL__");
    }
   function filtra() {
  const zone = getSelezionati("zonaFilter");
  const tipi = getSelezionati("tipoFilter");
  const cons = getSelezionati("consigliatoFilter");
  const gf = getSelezionati("glutenFilter");

  const f = locali.filter(l =>
    (zone.length === 0 || zone.includes(l.zona)) &&
    (tipi.length === 0 || tipi.some(t => l.tipo.split("+").includes(t))) &&
    (
      cons.length === 0 ||
      (
 (
  cons.includes("Miei locali") &&
  (
    (l.consigliatoDa || "").trim().toLowerCase() === myName.trim().toLowerCase() ||
    isPreferito(l.nome, l.zona, l.consigliatoDa)
  )
) ||
cons.includes((l.consigliatoDa || "‚Äî").trim())


    ) &&
    (gf.length === 0 || gf.includes(l.glutenFree))
  );

  mostra(f);
}


    // --- Random ---
 function randomLocale() {
  if (locali.length === 0) {
    mostraPopup("Nessun locale", "Non ci sono locali disponibili.");
    return;
  }

  const r = locali[Math.floor(Math.random() * locali.length)];
  mostraPopup("Locale casuale üé≤", `Prova: ${r.nome} (${r.tipo} in zona ${r.zona})`);
}


    // --- Import/Export ---
    let datiImport = [];
    function importaCSV(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const text = e.target.result.trim();
        const lines = text.split("\n").slice(1);
        datiImport = lines.map(line => {
          const values = line.split(/[,;]/).map(v => v.replace(/^"|"$/g, "").trim());

          if (values.length >= 8) {
            const [nome, zona, tipo, link, voto, consigliatoDa, glutenFree, commento] = values;
            return { nome, zona, tipo, link, voto, consigliatoDa: consigliatoDa || "‚Äî", glutenFree, commento };
          }
          return null;
        }).filter(x => x);
        const cons = [...new Set(datiImport.map(l=>l.consigliatoDa||"‚Äî"))];
        const box = document.getElementById("checkboxes");
        box.innerHTML = cons.map(c=>`<label><input type="checkbox" value="${c}" checked> ${c}</label>`).join("");
        document.getElementById("overlay").style.display="flex";
      };
      reader.readAsText(file);
    }
    function confermaImport() {
      const selezionati = [...document.querySelectorAll("#checkboxes input:checked")].map(cb=>cb.value);
      datiImport.forEach(l=>{
        if (selezionati.includes(l.consigliatoDa||"‚Äî")) {
          const duplicato = locali.some(ex=>ex.nome===l.nome && ex.zona===l.zona && ex.consigliatoDa===l.consigliatoDa);
          if (!duplicato) locali.push(l);
        }
      });
      salva(); mostra(); chiudiPopup();
    }
    function chiudiPopup(){ document.getElementById("overlay").style.display="none"; }

    // --- Condivisione/Reset ---
   function condividiLista() {
  const header = "Nome,Zona,Tipo,Link,Voto,ConsigliatoDa,GlutenFree,Commento\n";
  const rows = locali.map(l => `"${l.nome}","${l.zona}","${l.tipo}","${l.link}","${l.voto || ""}","${l.consigliatoDa || ""}","${l.glutenFree || ""}","${l.commento || ""}"`);
  const csv = header + rows.join("\n");
  const filename = "locali_" + myName.replace(/\s+/g, "_") + ".csv";
  const blob = new Blob([csv], { type: "text/csv" });

  if (navigator.canShare && navigator.canShare({ files: [new File([blob], filename, { type: "text/csv" })] })) {
    const file = new File([blob], filename, { type: "text/csv" });
    navigator.share({
      files: [file],
      title: "Lista Locali",
      text: "Ecco la mia lista di locali üìé"
    }).catch(err => console.log("Condivisione annullata:", err));
  } else {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);

  }
}

    function richiediLista() {
      const text = encodeURIComponent("Ciao üëã puoi condividere con me la tua lista locali?");
      window.open(`https://wa.me/?text=${text}`, "_blank");
    }
    function resetLista() {
      if (confirm("Vuoi davvero resettare la lista ai valori iniziali?")) {
        localStorage.removeItem("locali"); location.reload();
      }
    }

    // --- Menu ---
    function toggleMenu(event) {
      event.stopPropagation(); document.querySelector(".menu").classList.toggle("show");
    }
    function chiudiMenu() {
      document.querySelector(".menu").classList.remove("show");
    }
function chiudiPopupAggiunto() {
  document.getElementById("popupAggiunto").style.display = "none";
}
  carica(); 
  </script>

   

  <!-- Service worker -->
  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(() => console.log('Service Worker registrato'))
        .catch(err => console.log('Errore Service Worker:', err));
    });
  }
  </script>

  <!-- Pulsante installa PWA -->
  <script>
  let deferredPrompt;

  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault(); // blocca il banner automatico
    deferredPrompt = e; // salviamo per dopo
    document.getElementById("installButton").style.display = "block"; // mostra il pulsante
  });

  async function installApp() {
    if (!deferredPrompt) return;
    deferredPrompt.prompt(); // mostra popup
    const { outcome } = await deferredPrompt.userChoice;
    console.log(`Installazione: ${outcome}`); // 'accepted' o 'dismissed'
    deferredPrompt = null;
    document.getElementById("installButton").style.display = "none";
  }

  window.addEventListener("appinstalled", () => {
    alert("App LocaliFI installata correttamente üéâ");
  });
  </script>

</body>
</html>







